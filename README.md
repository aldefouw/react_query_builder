# React Query Builder

## Gemfile Dependencies
```
gem 'react_query_builder'

gem 'bootstrap'
gem 'jquery-rails'
gem 'jquery-ui-rails'
gem 'react-rails'
gem 'simple_form'
gem 'reform'
gem 'reform-rails'
```

## Development group in Gemfile
```
gem 'scenic'
```

## Install Migrations and Models
```
rails g react_query_builder:install
```


### Add a New View
```
rails g react_query_builder:view <view_name_here>
```

**Example:**
```
rails g react_query_builder:view person
```

A versioned Scenic view will be generated that must be defined in order for the view to show up in Query Builder.

Each time you run the `rails g react_query_builder:view person` command, along with a new database migration, a new version of the view will be generated in the views folder:

```
db/views/qb_view_name_v01.sql
db/views/qb_view_name_v02.sql
db/views/qb_view_name_v03.sql
```

You must specify the raw SQL needed within the view.  

### Person View Example

A view is typically support by a standard **ActiveRecord** model.

In this case, it would be sensible to generate a **Person** model if you don't already have one.

```
rails g model Person last_name:string first_name:string middle_name:string
```

**Location**
```
db/views/qb_view_person_01.sql
```

**Contents**
```
SELECT people.id,
       people.last_name,
       people.first_name,
       people.middle_name
FROM people;
```



## Run Migrations
`rails db:migrate`



## Button CSS Styling

By default, there is a **react_query_builder.css** file added to your stylesheets directory.  Within that file, you can make any necessary styling adjustments to the look and feel of the Query Builder.

All of the buttons within the application have class references you can use to easily override the default styling provided.

### Apply to All Buttons:
```
# ALL BUTTONS
.rqb_btn { }
```

### Apply to Specific Buttons:
```
# BACK
.rqb_back_btn { }

# RUN
.rqb_run_btn { }

# EDIT
.rqb_edit_btn { }

# DELETE
.rqb_delete_btn { }

# EXCEL
.rqb_excel_btn { }

# CSV 
.rqb_csv_btn { }

# SAVE AS
.rqb_save_as_btn { }

# SAVE
.rqb_save_btn { }

# NEW QUERY
.rqb_new_query_btn { }

# BACK
.rqb_back_btn { }

# DISPLAY FIELDS
.rqb_display_fields_btn { }

```

### Overriding methods using Initializers

You can easily override default behavior of the gem by placing an evaluated version of a class as an initializer file in your app:


You might, for example, create a file named:

`/app/config/initializers/react_query_builder.rb`

To override some controller behavior in the base app:

```
ReactQueryBuilder::QueryBuilderController.class_eval do

	def method_name
		#Whatever override behavior you want to use
	end

end
```

### Default Behavior & Inheritance

React Query Builder uses an abstract class to allow you to set default functionality across the entire Gem.

If you need some default behavior inherited, do it within **QueryBuilderRecord**.  

An example would be if you needed to query against a different database than the one **ActiveRecord** points to in your application.   In that case, you'd change the class that **QueryBuilderRecord** inherits from.

```
app/models/query_builder_record.rb
```

By default, the class inherits from **ApplicationRecord**.

```
class QueryBuilderRecord < ApplicationRecord

	...

end
```

You can also use the **QueryBuilderRecord** to specify any system-wide behavior you want inherited by all other Query Builder views.  

Query Builder views are any models prefixed by **qb_** in the filename.  They are generated by using the `rails g react_query_builder:view <view_name_here>` command.


### Preventing Data Bleeds

If you have permissions assigned to data models, you might need to prevent certain views from being accessible to a particular user.

You can achieve this by overriding the default #result_data method in the initializer.

For example, you might choose to pass options with multiple keys that contains the current_ability that a user has (in case of using CanCanCan).

```
ReactQueryBuilder::QueryBuilderController.class_eval do

	#This allows the controller to use the user's current ability to prevent data bleeds!
	def result_data
		@report.results({search: @search, current_ability: current_ability})
	end

end
```


All data queries are made at a single spot within the Query Record model:

```
app/models/query_builder_record.rb
```

```
class QueryBuilderRecord < ApplicationRecord

    ...
    
    def self.results(options)
        #method override goes here
    end
    
    ...
    
end    
```

If you have some exception to the default behavior, you can also override the method in a specific Query Builder model:

```
class QbPerson < ::QueryBuilder

	...

	def self.results(options)
		#method override goes here
	end
	
	...

end   
```

### Specifying Custom Username Method

By default, React Query Builder is configured to use the **#username** method of the current_user.  

If you are using a different method, it can be overriden by specifying a different method name within:
```
app/models/query_builder_record.rb
```

```
class QueryBuilderRecord < ApplicationRecord

	...

	def self.user_method
		"custom_method_name_here"
	end
	
	...

end
```


### Rails 7 - Turbo Rails & Import Maps

By default, Rails 7 comes with `@hotwired/turbo-rails` and `importmaps` gem.  

Within `javascript/application.js` you will see:

```
import "@hotwired/turbo-rails"
```

This implementation is NOT currently compatible with React Query Builder.

Pull requests are welcome if you have an implementation that is backwards compatible.
